<!doctype html>
<head>
  <meta charset="utf-8">
  <style>
	#DSDATA{
                position:       absolute;
                left:           70%;
                top:            5%;
                width:          150px;
                height:         90px;
                border:         1;
                background:     lightgreen;
             }

	#DSTRACKLIST{
                position:       absolute;
                left:           10%;
                top:            10%;
                width:          150px;
                height:         90px;
                border:         1;
                background:     lightblue;
             }

	#DRIVERDATA{
                position:       absolute;
                left:           45%;
                top:            30%;
                width:          150px;
                height:         90px;
                border:         1;
                background:     lightgrey;

  </style>
   <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
   <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
   <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
   <script>
	$(function() {
                    $( "#DSDATA" ).draggable();
		    $( "#DSTRACKLIST" ).draggable();
		    $( "#DRIVERDATA" ).draggable();
                  });
   </script>
   <!-- The jqGrid language file code-->
   <link rel="stylesheet" type="text/css" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/css/ui.jqgrid.css"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/i18n/grid.locale-de.js"></script>
   <!-- The actual jqGrid code -->
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/jquery.jqGrid.src.js"></script>

  <title>HTML5 WebWorker Testseite</title>
</head>
<body>

	<div id=DSDATA><p1 id=DSDATAP>TestText</p1></div>
	<div id=DSTRACKLIST><table id="tracklisttable"></table></div>
	<div id="DRIVERDATA"><table id="DriverDataTable"></table></div>

<script>

	var globalcnt = 0;

	//http://www.html5rocks.com/de/tutorials/workers/basics/
	// create new worker ///////////////////////////////////////////////////////////////////////////////////////
	var callParams	=	{workerdelay: 1000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETDSDATA"};
	var worker 	= 	new Worker('./worker_dsdata.js');

	//event handler of the worker
	worker.addEventListener('message', function(e) {
		//console.log('Worker said: ', e.data);
		drawDsData(e);
		globalcnt++;
		 //call worker again if first run finished -> currently endless loop
//		 worker.postMessage(callParams);		
	}, false);

	//initial start worker and send params
        worker.postMessage(callParams);


	
	// create worker for Tracklist updates //////////////////////////////////////////////////////////////////////
	var worker2      =       new Worker('./worker_tracklist.js');
	worker2.addEventListener('message', function(e) {

//   	        console.log('Worker2 Tracklist said: ', e.data);
		refreshTrackList(e);
//		worker2.postMessage({workerdelay: 5000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETTRACKLIST" });

        }, false);
	//todo: call this function not each time, implement an delay for each worker
	worker2.postMessage({workerdelay: 5000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETTRACKLIST" });


	jQuery("#tracklisttable").jqGrid({	
	        datatype: "local",
	        height: 250,
	        colNames:['ID','TrackID','TrackName', 'RefPoints exists?','Comment'],
	        colModel:[
			{name:'id', index:'id', formatter: 'integer', width:100},
	                {name:'trackid', index:'trackid', width:100},
	                {name:'trackname', index: 'trackname', width:200},
	                {name:'refpoint', width:90, align:"right",sorttype:"float"},
			{name:'comment', width:160, align:"left"},
	        ],
	        caption: "List of available Tracks",
		rowNum: 200,
	});

	// initial data for grid !!! 
	jQuery("#tracklisttable").jqGrid('addRowData',0,{	id: 0
								,trackid:	"1" 
								,trackname: 	"initialdata"
								,refpoint:	"no"
								,comment:	"" 
							});

	// create worker for Driver data updates //////////////////////////////////////////////////////////////////////
	var workerDRIVERDATA      =       new Worker('./worker_driverdata.js');

	workerDRIVERDATA.addEventListener('message', function(e) {

                console.log('Worker3 DriverList said: ', e.data);
                refreshDriverList(e);
                workerDRIVERDATA.postMessage({workerdelay: 2000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETDRIVERDATE" });

        }, false);
        //todo: call this function not each time, implement an delay for each worker
        workerDRIVERDATA.postMessage({workerdelay: 2000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETDRIVERDATE" });
	
	jQuery("#DriverDataTable").jqGrid({
                datatype: "local",
                height: 200,
		width: 800,
		caption: "List of available drivers",
                colNames:['RefID','Pos', 'Driver Name', 'State', 'Sector', 'fastest lap', 'last lap','PosX', 'PosY', 'PosZ' ],
                colModel:[
                        {name:'refid',index:'invdate', width:40},
			{name:'driverposition',index:'name', width:15, search:true},
                        {name:'drivername',index:'name', width:75, search:true},
			{name:'driverstate',width:40, align:"center",sorttype:"float"},
			{name:'driversector',width:10, align:"center",sorttype:"float"},
			{name:'fastestlap',width:20, align:"center",sorttype:"float"},
			{name:'lastlap',width:20, align:"center",sorttype:"float"},
			{name:'posx',width:20, align:"center",sorttype:"float"},
                        {name:'posy',width:20, align:"center",sorttype:"float"},
                        {name:'posz',width:20, align:"center",sorttype:"float"}
                ]
	});


	//change elements in HTML
	//http://www.html-seminar.de/javascript-html-elemente-aendern.htm
	var inhalt = document.getElementById('DSDATAP');
	var inhalt2= document.getElementsByTagName('p');
	console.log("HTML Inhalt", inhalt.innerHTML);
	console.log("HTML inhalt2:", inhalt2);
	//////////////////////////////////////////	



//////////////// functions
function drawDsData(a){

	var html;
	html = 	'DS Url: ' + 
	a.data.state + " / " + globalcnt;

	document.getElementsByTagName('p1')[0].innerHTML = html;

}

function refreshTrackList(a)
{

	console.log("refreshTrackList(): " , a);
	//jQuery("#tracklisttable").jqGrid('GridUnload');		// destroy complete table working
	//jQuery("#tracklisttable").trigger("clearGridData");		// unload did not work :-(

	var grididcnt = 0;
	var _data;
	// get current sizre of the table
	var GridSize = jQuery("#tracklisttable").getGridParam("reccount");


	//console.log("Current Table size: " , GridSize);

	for (i=0; i < a.data.length; i++)
	{
		//console.log("update data on row: " + i + " / " + a.data[i]);

		_data = {      id:             grididcnt
                               ,trackid:       a.data[i].trackid
                               ,trackname:     a.data[i].trackname
                               ,refpoint:      a.data[i].refpoint
                               ,comment:       a.data[i].comment
                        };

		//decision if replace or add a row to jqGrid
		if (i < GridSize)
		{
			jQuery("#tracklisttable").jqGrid('setRowData',i, _data);
			//console.log("+++++ set " + i );
		}else{
			jQuery("#tracklisttable").jqGrid('addRowData',i, _data);
			//console.log("+++++ add " + i );
		}
	
		grididcnt++;
		
	}
	
	jQuery("#tracklisttable").trigger("reloadGrid");
	
	console.log("jqGrid after setDatat(): " , jQuery("#tracklisttable"));

	return 1;
}

//////////////////
function refreshDriverList(a)
{

        console.log("refreshDriverList(e): " , a);

	var grididcnt = 0;
        var _data;
        // get current sizre of the table
        var GridSize = jQuery("#DriverDataTable").getGridParam("reccount");	
	
	for (i=0; i < a.data.length; i++)
        {
                //console.log("update data on row: " + i + " / " + a.data[i]);

                _data = {   
				refid:			a.data[i].RefID
				,driverposition:	a.data[i].RacePos	
				,drivername:		a.data[i].Name
	                        ,driverstate:		a.data[i].State
	                        ,driversector:		a.data[i].CurrentSector
	                        ,fastestlap:		a.data[i].FastestLapTime
	                        ,lastlap:		a.data[i].LastLapTime
	                        ,posx:			a.data[i].PosX
	                        ,posy:			a.data[i].PosY
	                        ,posz:			a.data[i].PosZ
                        };

                //decision if replace or add a row to jqGrid
                if (i < GridSize)
                {
                        jQuery("#DriverDataTable").jqGrid('setRowData',i, _data);
                        console.log("+++++ set " + i );
                }else{
                        jQuery("#DriverDataTable").jqGrid('addRowData',i, _data);
                        console.log("+++++ add " + i );
                }

                grididcnt++;

        }

	console.log("Driver table: ", _data);

        jQuery("#DriverDataTable").trigger("reloadGrid");



	return 1;
}

</script>

	

</body>
