<!doctype html>
<head>
  <meta charset="utf-8">
  <style>
	#DSDATA{
                position:       absolute;
                left:           10%;
                top:            5%;
                width:          150px;
                height:         90px;
                border:         1;
                background:     lightgreen;
             }

	#DSTRACKLIST{
                position:       absolute;
                left:           15%;
                top:            15%;
                width:          150px;
                height:         90px;
                border:         1;
                background:     lightblue;
             }


  </style>
   <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
   <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
   <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
   <script>
	$(function() {
                    $( "#DSDATA" ).draggable();
		    $( "#DSTRACKLIST" ).draggable();
                  });
   </script>
   <!-- The jqGrid language file code-->
   <link rel="stylesheet" type="text/css" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/css/ui.jqgrid.css"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/i18n/grid.locale-de.js"></script>
   <!-- The actual jqGrid code -->
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/jquery.jqGrid.src.js"></script>

  <title>HTML5 WebWorker Testseite</title>
</head>
<body>

	<div id=DSDATA><p1 id=DSDATAP>TestText</p1></div>
	<div id=DSTRACKLIST><table id="tracklisttable"></table></div>

<script>

	var globalcnt = 0;

	//http://www.html5rocks.com/de/tutorials/workers/basics/
	// create new worker ///////////////////////////////////////////////////////////////////////////////////////
	var callParams	=	{workerdelay: 1000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETDSDATA"};
	var worker 	= 	new Worker('./worker_dsdata.js');

	//event handler of the worker
	worker.addEventListener('message', function(e) {
		console.log('Worker said: ', e.data);
		drawDsData(e);
		globalcnt++;
		 //call worker again if first run finished -> currently endless loop
		 worker.postMessage(callParams);		
	}, false);

	//initial start worker and send params
        worker.postMessage(callParams);


	
	// create worker for Tracklist updates //////////////////////////////////////////////////////////////////////
	var worker2      =       new Worker('./worker_tracklist.js');
	worker2.addEventListener('message', function(e) {

                console.log('Worker2 Tracklist said: ', e.data);
		refreshTrackList(e);

        }, false);
	//todo: call this function not each time, implement an delay for each worker
	worker2.postMessage({workerdelay: 5000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETTRACKLIST" });
//	worker2.postMessage({workerdelay: 5000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETTRACKLIST" });


	jQuery("#tracklisttable").jqGrid({	
	        datatype: "local",
	        height: 250,
	        colNames:['ID','TrackID','TrackName', 'RefPoints exists?','Comment'],
	        colModel:[
			{name:'id', index:'id', formatter: 'integer', width:100},
	                {name:'trackid', index:'trackid', width:100},
	                {name:'trackname', index: 'trackname', width:200},
	                {name:'refpoint', width:90, align:"right",sorttype:"float"},
			{name:'comment', width:160, align:"left"},
	        ],
	        caption: "List of available Tracks",
		rowNum: 200,
	});

	// initial data for grid !!! 
	jQuery("#tracklisttable").jqGrid('addRowData',0,{	id: 0
								,trackid:	"1" 
								,trackname: 	"initialdata"
								,refpoint:	"no"
								,comment:	"" 
							});


	//change elements in HTML
	//http://www.html-seminar.de/javascript-html-elemente-aendern.htm
	var inhalt = document.getElementById('DSDATAP');
	var inhalt2= document.getElementsByTagName('p');
	console.log("HTML Inhalt", inhalt.innerHTML);
	console.log("HTML inhalt2:", inhalt2);
	//////////////////////////////////////////	



//////////////// functions
function drawDsData(a){

	var html;
	html = 	'DS Url: ' + 
	a.data.state + " / " + globalcnt;

	document.getElementsByTagName('p1')[0].innerHTML = html;

}

function refreshTrackList(a)
{

	console.log("refreshTrackList(): " , a);
	//jQuery("#tracklisttable").jqGrid('GridUnload');		// destroy complete table working
	//jQuery("#tracklisttable").trigger("clearGridData");		// unload did not work :-(

	var grididcnt = 1;
	// get current sizre of the table
	var GridSize = jQuery("#tracklisttable").getGridParam("reccount");
	//console.log("Current Table size: " , GridSize);

	for (i=0; i <= a.data.length; i++)
	{
		console.log("update data on row: " + i + " / " , a.data[i].trackid);
		//decision if replace or add a row to jqGrid
		if (i <= GridSize)
		{
			jQuery("#tracklisttable").jqGrid('setRowData',i, {      id:		grididcnt
										,trackid:	a.data[i].trackid
	                                                                	,trackname: 	a.data[i].trackname
	                                                                	,refpoint:	a.data[i].refpoint
	                                                                	,comment:	a.data[i].comment
	                                                        	});
			console.log("+++++ set " + i );
		}else{
			jQuery("#tracklisttable").jqGrid('addRowData',i,{       id:		grididcnt
										,trackid:       a.data[i].trackid
                        	                                                ,trackname:     a.data[i].trackname
                                	                                        ,refpoint:      a.data[i].refpoint
                                        	                                ,comment:       a.data[i].comment
                                                	                });
			console.log("+++++ add " + i );
		}

		grididcnt++;		
	}
	

	jQuery("#tracklisttable").trigger("reloadGrid");
	
	console.log("jqGrid after setDatat(): " , jQuery("#tracklisttable"));

	worker2.postMessage({ dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETTRACKLIST" });

}


</script>

	

</body>
