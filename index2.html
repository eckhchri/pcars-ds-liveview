<!DOCTYPE html>
 <html>
     <head>
         <title>Project Cars DS - live view with position update.</title>
         
         <script src="https://maps.google.com/maps/api/js??v=3.exp&sensor=true"></script>
	 <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.3.3/d3.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/js-url/1.8.6/url.min.js"></script>
 
	 <script src="./pcars_driver.js" charset="utf-8"></script>
	 <script src="./receive_ds_data.js" charset="utf-8"></script>
	 <script src="./calc_coordinates.js" charset="utf-8"></script>
	 <script src="./class_reference_points.js" charset="utf-8"></script>
	 <script src="./get_url_param.js" charset="utf-8"></script>

	<!--Ermoeglicht das verschieben von DIV Bloecken -->
	<!-- Jquery UI needed for jTable-->
        <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
        <script>
                  $(function() {
                    $( "#DSdata" ).draggable();
                //    $( "#DriverData" ).draggable();
		    $( "#TrackList" ) .draggable();
		    $( "#DriverDataArea" ) .draggable();
                  });
        </script>

	<!-- The jqGrid language file code-->
        <link rel="stylesheet" type="text/css" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/css/ui.jqgrid.css"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/i18n/grid.locale-de.js"></script>
        <!-- The atual jqGrid code -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/jquery.jqGrid.src.js"></script>



         
        <style type="text/css">

             html, body, #map {
                 width: 90%;
                 height: 90%;
                 margin: 0;
                 padding: 0;
             }
	     #DSdata{
		position: 	absolute; 
		left: 		55%; 
		top: 		5%; 
		width: 		300px; 
		height: 	100px;
		border:		1;
		background:	lightgreen;
	     }

	     #TrackList{
		position:       absolute;
                left:           25%;
                top:            65%;
                border:         1;
		text-align: 	center;
	     }

	     #DriverData{
		position:       absolute;
                left:           55%;
		top:		250px;
		background:	lightblue;
	     }
		
	     #DriverDataArea{
		position:       absolute;
		left:           55%;
		top:            330px;
	     }

             .stations, .stations svg {
                 position: absolute;
             }

             .stations svg {
                 width: 60px;
                 height: 20px;
                 padding-right: 100px;
                 font: 10px sans-serif;
             }

             .stations circle {
                 fill: brown;
                 stroke: black;
                 stroke-width: 1.5px;
             }

         </style>
     </head>
   <body>
       <div id="map"></div>
      
       <script>


	// initialize vars
	var aDrivers 	= new Array();		// array for PCARSdriver objects
	var aSensorData = new Array();		// array of Hashes, each hash includes parameters of a driver
	var DsServerURL = "www.eckhchri.de";
	var DsPort	= 9000;
	var XMLHTTPTimeout = 2000;
	var DisplayDuration = 700;		// duration for displaying marker updates
	var global_i		= 0;
	var map;				// google map object
	var sensorLayer;
	var aRefPointTMP;			// hash of all RefPoints for available tracks
	var WORKERDELEAY_TRACKLIST	=	5000; 	// in ms

	// check if url params overwrite the default ds info
	if (get_url_param('dsurl') && get_url_param('dsport'))
        {
                DsServerURL     =       get_url_param('dsurl');
                DsPort          =       get_url_param('dsport');

		console.log("overwrite ds default settings with: " 
				+ get_url_param('dsurl') 
				+ " / " 
				+ get_url_param('dsport'));
	}


	// Test Area
	// ACHTUNG	3. Parameter muss die Z Koordinate sein !!!!!!		
	//         calc_coordinates( cuircitid,  aDrivers[i].GetPosX() , aDrivers[i].GetPosZ() );	
	//	calc_coordinates (1695182971 ,-621990, -133340);


	//StreckenID Liste holen 
        var aTrackList = Receive_DS_data(DsServerURL, DsPort, 2000, "GETTRACKLIST");
        //console.log("TRACKLIST: " , aTrackList);

	// Allgemeine DS Daten abfragen (Race, Qualifying, ...)
	var aDsData 	= Receive_DS_data(DsServerURL, DsPort, 2000, "GETDSDATA");
	console.log("DSdata complete array: " , aDsData);

	// set to global var, to modify in future stage for periodical updates via ajax
	var DsName 		=	aDsData.name;
	var DsState		=	aDsData.state;		//idle/running
	var DsTrackName		=	aTrackList[aDsData.TrackId];
	var DsMaxMemberCnt	=	aDsData.max_member_count;
	var cuircitID		=	aDsData.TrackId;	


	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// create DS data object
	document.write('<div id="DSdata"><p0>-</p0><br><p1></p1><br><p2></p2><br><p3></p3><br><p4></p4></div>');

	var workerDSDATA      =       new Worker('./worker_dsdata.js');

        //event handler of the worker
        workerDSDATA.addEventListener('message', function(e) {

                console.log('Worker said: ', e.data);
                // write in HTML page
		document.getElementsByTagName('p0')[0].innerHTML = 'DS URL:   ' + DsServerURL + " : " +  DsPort;
                document.getElementsByTagName('p1')[0].innerHTML = 'DS Status:   ' + e.data.state;
		document.getElementsByTagName('p2')[0].innerHTML = 'DS Joinable: ' + e.data.joinable;
		document.getElementsByTagName('p3')[0].innerHTML = 'DS Lobby ID: ' + e.data.lobbyid;
		document.getElementsByTagName('p4')[0].innerHTML = 'DS now:      ' + e.data.now; 

		//console.log("HTML Elements" , document.getElementsByTagName('p1'));

		//call worker again for next itteration -> currently endless loop
		workerDSDATA.postMessage({workerdelay: 100, dsurl: DsServerURL, dsport: DsPort, timeout: XMLHTTPTimeout, receivemode: "GETDSDATA"});

        }, false);

	//initail call of the worker
	workerDSDATA.postMessage({workerdelay: 100, dsurl: DsServerURL, dsport: DsPort, timeout: XMLHTTPTimeout, receivemode: "GETDSDATA"});


	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// receive data from pcars dedicated server (DS) and returns an array of PCARSdriver objects
	//	   Receive_DS_data(url,port,timeout,RetrivelMode)
	aDrivers = Receive_DS_data(DsServerURL, DsPort, 2000, "GETDRIVERDATE");

	//console.log ("Rueckgabewert Funktion Receive_DS_data:" +  aDrivers);

	// todo: check if logic is OK
	if (cuircitID == "" || cuircitID == undefined){
		cuircitID            =       1695182971;		//  set default value Hockenheim
	}


	// get List of alle RefPoints
	aRefPointTMP         =      new Refpoint( cuircitID );
	//console.log ("++++++++++++++aRefPointTMP: " , aRefPointTMP);


	// create Table with list of all tracks
	// todo: make table searchable   and  add new Theme
	document.write('<div id="TrackList"><table id="tracklisttable"></table></div>');

	// create worker for Tracklist updates //////////////////////////////////////////////////////////////////////
	var w_tracklist      =       new Worker('./worker_tracklist.js');
	
	w_tracklist.addEventListener('message', function(e) {
                //console.log('Worker2 Tracklist said: ', e.data);
		refreshTrackList(e);
		w_tracklist.postMessage({workerdelay: WORKERDELEAY_TRACKLIST, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETTRACKLIST" });
        }, false);
	
	//initial call of the tracklist worker. initiate endless loop
	w_tracklist.postMessage({workerdelay: 2000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETTRACKLIST" });

	// initiate jqGrid
	// todo: add subgrid information like: Long,Lat,RefPoint,...
	jQuery("#tracklisttable").jqGrid({	
	        datatype: "local",
	        height: 250,
	        colNames:['ID','TrackID','TrackName', 'RefPoints exists?','Comment'],
	        colModel:[
			{name:'id', index:'id', formatter: 'integer', width:100},
	                {name:'trackid', index:'trackid', width:100},
	                {name:'trackname', index: 'trackname', width:200},
	                {name:'refpoint', width:90, align:"right",sorttype:"float"},
			{name:'comment', width:160, align:"left"},
	        ],
	        caption: "List of available Tracks",
		rowNum: 200,
	});

	// initial data for grid !!! Needed because of Refresh problem !!
	jQuery("#tracklisttable").jqGrid('addRowData',0,{	id: 0
								,trackid:	"1" 
								,trackname: 	"initialdata"
								,refpoint:	"no"
								,comment:	"" 
							});


	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // create DriverList object

	//display Driver Data with jqGrid
	document.write('<div id="DriverDataArea"><table id="DriverDataTable"></table></div>');


	// create worker for Driver data updates //////////////////////////////////////////////////////////////////////
	var workerDRIVERDATA      =       new Worker('./worker_driverdata.js');
	workerDRIVERDATA.addEventListener('message', function(e) {
                console.log('Worker3 DriverList said: ', e.data);
                refreshDriverList(e);
                workerDRIVERDATA.postMessage({workerdelay: 2000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETDRIVERDATE" });
        }, false);
        //initial call of worker and start the loop
        workerDRIVERDATA.postMessage({workerdelay: 2000, dsurl: "www.eckhchri.de", dsport: 9000, timeout: 2000, receivemode: "GETDRIVERDATE" });


	//todo: add subgrid for more drivers information
	jQuery("#DriverDataTable").jqGrid({
                datatype: "local",
                height: 200,
		width: 800,
		caption: "List of available drivers",
                colNames:['RefID','Pos', 'Driver Name', 'State', 'Sector', 'fastest lap', 'last lap','PosX', 'PosY', 'PosZ' ],
                colModel:[
                        {name:'refid',index:'invdate', width:40},
			{name:'driverposition',index:'name', width:15, search:true},
                        {name:'drivername',index:'name', width:75, search:true},
			{name:'driverstate',width:40, align:"center",sorttype:"float"},
			{name:'driversector',width:10, align:"center",sorttype:"float"},
			{name:'fastestlap',width:20, align:"center",sorttype:"float"},
			{name:'lastlap',width:20, align:"center",sorttype:"float"},
			{name:'posx',width:20, align:"center",sorttype:"float"},
                        {name:'posy',width:20, align:"center",sorttype:"float"},
                        {name:'posz',width:20, align:"center",sorttype:"float"}
                ]
	});

	
	// setting up google maps overlays
	function GPSSensor(initData) {
               //state information
               var _div = null;
               var _data = initData;
               var _projection = null;

               function transform(d) {
                   var padding = 10;                   
                   d = new google.maps.LatLng(d.Lat, d.Long);
                   d = _projection.fromLatLngToDivPixel(d);
                   return d3.select(this) 
                       .style("left", (d.x - padding) + "px")
                       .style("top", (d.y - padding) + "px");
               }
               
               function transformWithEase(d) {
                   var padding = 10;
                   d = new google.maps.LatLng(d.Lat, d.Long);
                   d = _projection.fromLatLngToDivPixel(d);
                   return d3.select(this)
                       .transition().duration(DisplayDuration)
                       .style("left", (d.x - padding) + "px")
                       .style("top", (d.y - padding) + "px");
               }

               //superclass methods for google maps
               this.onAdd = function() {
                   _div = d3.select(this.getPanes().overlayLayer)
                            .append("div")
                            .attr("class", "stations");
               };               
                              
               this.draw = function () {                   
                   var padding = 10;
                   _projection = this.getProjection();
		  
                   var marker = _div.selectAll("svg")
                       .data(_data, function (d) { return d.Key; })
                       .each(transform) // update existing markers
                        .enter().append("svg:svg")
                       .each(transform)
                       .attr("class", "marker");

		   console.log("++ Marker" , marker);

                   // Add a circle.
                   marker.append("svg:circle") 
                       .attr("r", 4.5)
                       .attr("cx", padding)
                       .attr("cy", padding)
		       .style("fill", "red");

		//todo experimental method call	
		//marker.text("test123456");	
		   console.log("Marker: " , marker);
		

                   // Add a label.
		   console.log ("++++ in function draw() ->  aSensorData: " , aSensorData);
                   marker.append("svg:text")
                       .attr("x", padding + 7)
                       .attr("y", padding)
                       .attr("dy", ".31em")
			//todo !!!!!!!!!!!!!!!!!!!!   very uggly implementation !!! only temporary workaround
			//      it seem that the function within .text(...) will called only once at the beginning 
			//      question: is it possible to call _div.selectAll("svg") and set text style direct in loop() ??
		       .text(function (d) {
						console.log("+++++ d:" , d);

						for (var i = 0; i < aSensorData.length; i++){
						
							console.log(" for Update MarkerLabel:" , aSensorData);
							if (aSensorData[i].Key == d.Key){
								console.log("Match found ---- Update MarkerLabel: " , aSensorData[i].MarkerLabel);
								return  aSensorData[i].MarkerLabel;
							}
						}
						
						//todo: during update d is not an array its an individual hash
						console.log("++++not array:");
						return d.MarkerLabel;
						
					})
               //       .text(function (d) { return d.Key; });                                      
               };

               this.onRemove = function () {
                   _div.remove();
               };


		// todo: known issue: Beim Wechsel der Position, bleibt eine "Leiche" auf der Karte uebrig, weil Key "Pos - Name" zusammensetzt
		// easyt solution:  deleting leading position number 
               this.update = function (data) {                    
                   //update internal data which drive redrawing on zoom_changed                  

                 	for (var i = 0; i < data.length; i++) {
			       //console.log ("------------------------------------------- data", data);
	                       var found = false;
	                       for (var j = 0; j < _data.length; j++) {
	                           if (_data[j].Key === data[i].Key) {
	        	                       found = true;
	                               _data[j].Lat = data[i].Lat;
	                               _data[j].Long = data[i].Long;
				       _data[j].MarkerLabel = data[i].MarkerLabel;
				//	console.log("---12 _data changes for key:" + _data[j].Key + " // " + data[i].Key);
	                           }
	                       }
	                       if (!found)
	                           _data.push(data[i]);
	                   }

			   //todo: what does this draw() call ?
			   console.log ("THIS Updated data:" , _data);
			   console.log ("THIS:" , this);
	                   this.draw();
	                   _div.selectAll("svg")
	                       .data(_data, function (d) { return d.Key; }) 
	                       .each(transformWithEase);                
			 
               };
           }

	// init google map 
	init_map(cuircitID);

				
///////////////////////////////////////////////////
           //simulate position update by receiving positions at random interval
		   
           //var d1Cnt = 1, d2Cnt = 1;
	   var tmpcuircitID;	// to valida if global cuircitid differs from current
           (function loop() {


		// todo: reduce timeout for better performance ?	
		randTimeout = 500;
		console.log("--Timeout_Loop()" + randTimeout);
		tmpcuircitID = cuircitID;	// initialize var with currect TrackID

               setTimeout(function () {
		
		// collect live data 
                aDrivers = Receive_DS_data(DsServerURL, DsPort, 2000, "GETDRIVERDATE"); 
	
		for (var i = 0; i < aDrivers.length; i++ ){

			// calculate GPS coordinates
	                gpsCoTmp =  calc_coordinates (cuircitID , aDrivers[i].GetPosX() , aDrivers[i].GetPosZ() );
			//console.log("GPS coordinates: ", gpsCoTmp);
			
			// fill data array
			aSensorData[i] = {
				//	"Key": aDrivers[i].GetRacePosition() + "-" + aDrivers[i].GetName()
					"Key": aDrivers[i].GetName()
					,"MarkerLabel" : aDrivers[i].GetRacePosition() + "-" + aDrivers[i].GetName()
                                        ,"DateTime":"2013-09-04T09:41:09+10:00"
                                        ,"Lat": gpsCoTmp["Lat"]
                                        ,"Long": gpsCoTmp["Long"]
                                        ,"Heading":286.0
                                        ,"Speed":22
                                	}
			//console.log ("aDrivers[i]" , aDrivers[i]);
			tmpcuircitID = aDrivers[i].GetVariousParameter("TrackId");
		}	
		//console.log("-+-+- aSensorData-Array: ", aSensorData);
/*
		console.log("d3 object: " , d3);
		var _divtmp = d3.select(this.getPanes().overlayLayer)
                            .append("div")
                            .attr("class", "stations");

		var marker = _divtmp.selectAll("svg");
		console.log("Marker:" , marker);
*/
		// update draw data
		sensorLayer.update(aSensorData);

		
		//todo: Move map dynamically if cuircit changes to a new GPS coordinate
		if (cuircitID != tmpcuircitID ){
			//map.setCenter({lat: 50.332733, lng: 6.943355});	
			map.setCenter({lat: aRefPointTMP[tmpcuircitID]["MapInitLat"], lng: aRefPointTMP[tmpcuircitID]["MapInitLong"]});
			cuircitID = tmpcuircitID;  // give the global var the new TrackId
			console.log("TrackID changed. Call SetCenter() for the map. cuircitID / tmpcuircitID " + cuircitID + " / " + tmpcuircitID);
		}
		//todo: Kann man die marker direkt mit setPosition updaten?
		//marker.setPosition(latlng:LatLng|LatLngLiteral)
		//init_map(cuircitID);

                   loop();
               }, randTimeout);
			   
           }());           

//////////////////////////////////////////////////////////////////////////
function init_map(_TrackID)
{
           //subclassing
           GPSSensor.prototype = new google.maps.OverlayView();


           // Create the Google Map
           map = new google.maps.Map(d3.select("#map").node(), {
               zoom: aRefPointTMP[cuircitID]["Zoom"],

                // use ´cuircit RefPoint for center google map
                center: new google.maps.LatLng( aRefPointTMP[_TrackID]["MapInitLat"] , aRefPointTMP[_TrackID]["MapInitLong"] ),
                mapTypeId: google.maps.MapTypeId.SATELLITE
           });

           //console.log("-+-+- aSensorData-Array: ", aSensorData);
           sensorLayer = new GPSSensor(aSensorData);
           sensorLayer.setMap(map);
}

///////////////////
function refreshTrackList(a)
{
	console.log("refreshTrackList(): " , a);
	//jQuery("#tracklisttable").trigger("clearGridData");		// unload did not work :-(
	var grididcnt = 0;
	var _data;

	// get current sizre of the table
	var GridSize = jQuery("#tracklisttable").getGridParam("reccount");
	
	for (i=0; i < a.data.length; i++)
	{
		_data = {      id:             grididcnt
                               ,trackid:       a.data[i].trackid
                               ,trackname:     a.data[i].trackname
                               ,refpoint:      a.data[i].refpoint
                               ,comment:       a.data[i].comment
                        };
		//decision if replace or add a row to jqGrid
		if (i < GridSize)
		{
			jQuery("#tracklisttable").jqGrid('setRowData',i, _data);
		}else{
			jQuery("#tracklisttable").jqGrid('addRowData',i, _data);
		}
	
		grididcnt++;
	}
	
	jQuery("#tracklisttable").trigger("reloadGrid");
	
}

//////////////////
function refreshDriverList(a)
{
        console.log("refreshDriverList(e): " , a);
	var grididcnt = 0;
        var _data;
        // get current sizre of the table
        var GridSize = jQuery("#DriverDataTable").getGridParam("reccount");	
	
	for (i=0; i < a.data.length; i++)
        {
                //console.log("update data on row: " + i + " / " + a.data[i]);
                _data = {   
				refid:			a.data[i].RefID
				,driverposition:	a.data[i].RacePos	
				,drivername:		a.data[i].Name
	                        ,driverstate:		a.data[i].State
	                        ,driversector:		a.data[i].CurrentSector
	                        ,fastestlap:		a.data[i].FastestLapTime
	                        ,lastlap:		a.data[i].LastLapTime
	                        ,posx:			a.data[i].PosX
	                        ,posy:			a.data[i].PosY
	                        ,posz:			a.data[i].PosZ
                        };
                //decision if replace or add a row to jqGrid
                if (i < GridSize)
                {
                        jQuery("#DriverDataTable").jqGrid('setRowData',i, _data);
                        //console.log("+++++ set " + i );
                }else{
                        jQuery("#DriverDataTable").jqGrid('addRowData',i, _data);
                        //console.log("+++++ add " + i );
                }
                grididcnt++;
        }
	//console.log("Driver table: ", _data);
        jQuery("#DriverDataTable").trigger("reloadGrid");
	return 1;
}

       </script>
   </body>
